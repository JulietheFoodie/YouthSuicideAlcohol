---
title: "Data Upload Cleaning"
author: "Julie Norman"
date: "2/3/2019"
output: html_document
---

---
title: "Data Exploration"
output: html_document
---

## libraries

```{r}
library(dplyr)
library(tidyr)
library(readr)
library(haven)
library(data.table)
library(lubridate)
library(stringr)

setwd("~/Documents/Economics/YouthAlcoholSuicide/")
```


## Data Upload 

## suicide
source: https://wonder.cdc.gov/ 

### Census

```{r}
sui_cdf <- read_tsv("CensusSuicide 2012-2016.txt")

sui_cdf$Region <- str_sub(sui_cdf$`Census Region`, start= 18)

sui_cdf2 <- sui_cdf %>%
  filter(is.na(Notes) == TRUE)

totals_cdf <- filter(read_tsv("CensusSuicide 2012-2016.txt"), Notes == "Total")
```

### State

```{r}
sui_sdf <- read_tsv("StateSuicide 2012-2016.txt")

sui_sdf2 <- sui_sdf %>%
  filter(is.na(Notes) == TRUE)

totals_sdf <- filter(read_tsv("StateSuicide 2012-2016.txt"), Notes == "Total")
```

## Illicit Substance Usage
source: https://www.samhsa.gov/data/data-we-collect/nsduh-national-survey-drug-use-and-health
illicit drug general unavailable for some years 

https://www.samhsa.gov/data/report/2016-2017-nsduh-state-prevalence-estimates
https://www.samhsa.gov/data/report/2015-2016-nsduh-estimated-totals-state
https://www.samhsa.gov/data/report/2014-2015-nsduh-estimated-totals-state
https://www.samhsa.gov/data/report/2013-2014-nsduh-estimated-totals-state
https://www.samhsa.gov/data/report/2012-2013-nsduh-estimated-totals-state
https://www.samhsa.gov/data/report/2011-2012-nsduh-estimated-totals-state


### Marijuana 
NOTE: State and census region estimates, along with the 95 percent Bayesian confidence (credible) intervals, are based on a survey-weighted hierarchical Bayes estimation approach and generated by Markov Chain Monte Carlo techniques. For the "Total U.S." row, design-based (direct) estimates and corresponding 95 percent confidence intervals are given.																
	
NOTE: Estimated numbers appearing as 0 in this table mean that the estimate is greater than 0 but less than 500 (because estimated numbers are shown in thousands).																
Source: SAMHSA, Center for Behavioral Health Statistics and Quality, National Survey on Drug Use and Health, 2015 and 2016.																

#### Upload
```{r}
Marj16_df <- read_csv("NSDUH/NSDUHsaeTotalsCSVs-2016/NSDUHsaeTotals-Tab03-2016.csv", skip = 5) %>%
  select(Area = State, 'Marijuana Counts' = '12-17 Estimate') 
Marj16_df$Year <- "2016"

Marj15_df <- read_csv("NSDUH/NSDUHsaeTotalsCSVs-2015/NSDUHsaeTotals-Tab02-2015.csv", skip = 5) %>%
  select(Area = State, 'Marijuana Counts' = '12-17 Estimate') 
Marj15_df$Year <- "2015"

Marj14_df <- read_csv("NSDUH/NSDUHsaeTotalsCSVs-2014/NSDUHsaeTotalsTab02-2014.csv", skip = 4) %>%
  select(Area = State, 'Marijuana Counts' = '12-17 Estimate') 
Marj14_df$Year <- "2014"

Marj13_df <- read_csv("NSDUH/NSDUHsaeTotalsCSVs-2013/NSDUHsaeCountTab03-2013.csv", skip = 4) %>%
  select(Area = State, 'Marijuana Counts' = '12-17 Estimate') 
Marj13_df$Year <- "2013"


Marj12_df <- read_excel("NSDUH/NSDUHsaeTotals2012.xlsx", skip = 4, sheet = "Table 3") 
names(Marj12_df)[6]<-"12-17 Estimate" #column not recognized by name
Marj12_df <- Marj12_df %>%
  select(Area = State, 'Marijuana Counts' = '12-17 Estimate')
Marj12_df$Year <- "2012"

```

### Clean/ Merge

```{r}
Marj_df <- rbind(Marj12_df, Marj13_df) %>%
  rbind(Marj14_df) %>%
  rbind(Marj15_df) %>%
  rbind(Marj16_df)

Marj_df$Year <- as.character(Marj_df$Year)
```


```{r}
str(Marj12_df)
```


### Alcohol 
NOTE: State and census region estimates, along with the 95 percent Bayesian confidence (credible) intervals, are based on a survey-weighted hierarchical Bayes estimation approach and generated by Markov Chain Monte Carlo techniques. For the "Total U.S." row, design-based (direct) estimates and corresponding 95 percent confidence intervals are given.																

NOTE: Estimated numbers appearing as 0 in this table mean that the estimate is greater than 0 but less than 500 (because estimated numbers are shown in thousands).																

#### Upload

```{r}
Alco16_df <- read_csv("NSDUH/NSDUHsaeTotalsCSVs-2016/NSDUHsaeTotals-Tab12-2016.csv", skip = 5) %>%
  select(Area = State, 'Alcohol Counts' = '12-17 Estimate') 
Alco16_df$Year <- "2016"

Alco15_df <- read_csv("NSDUH/NSDUHsaeTotalsCSVs-2015/NSDUHsaeTotals-Tab06-2015.csv", skip = 5) %>%
  select(Area = State, 'Alcohol Counts' = '12-17 Estimate') 
Alco15_df$Year <- "2015"

Alco14_df <- read_csv("NSDUH/NSDUHsaeTotalsCSVs-2014/NSDUHsaeTotalsTab09-2014.csv", skip = 4) %>%
  select(Area = State, 'Alcohol Counts' = '12-17 Estimate') 
Alco14_df$Year <- "2014"

Alco13_df <- read_csv("NSDUH/NSDUHsaeTotalsCSVs-2013/NSDUHsaeCountTab09-2013.csv", skip = 4) %>%
  select(Area = State, 'Alcohol Counts' = '12-17 Estimate') 
Alco13_df$Year <- "2013"

Alco12_df <- read_excel("NSDUH/NSDUHsaeTotals2012.xlsx", skip = 4, sheet = "Table 9") 
names(Alco12_df)[6]<-"12-17 Estimate" #column not recognized by name
Alco12_df <- Alco12_df %>%
  select(Area = State, 'Alcohol Counts' = '12-17 Estimate')
Alco12_df$Year <- "2012"

```

#### Merge/Clean

```{r}
Alco_df <- rbind(Alco12_df, Alco13_df) %>%
  rbind(Alco14_df) %>%
  rbind(Alco15_df) %>%
  rbind(Alco16_df)

Alco_df$Year <- as.character(Alco_df$Year)

```


### Join 

#### Census

```{r}
CensusRegions <- c("Northeast" , "Midwest" , "South" , "West")



Drug_cdf <- left_join(Marj_df, Alco_df) %>%
  filter(Area %in% CensusRegions )

names(Drug_cdf)[names(Drug_cdf) == 'Area'] <- 'Region'
Drug_cdf$Year <- as.numeric(Drug_cdf$Year)

dirt_cdf <- left_join(sui_cdf2, Drug_cdf)

cdf <- select(dirt_cdf, 'Region', everything(),
             -c(Notes, 'Census Region', 'Census Region Code', 'Gender Code', 'Year Code'))

# pop in 1,000 and want percent
cdf$`Marj Usage` <- (cdf$`Marijuana Counts` / cdf$Population)*100000 
cdf$`Alco Usage` <- (cdf$`Alcohol Counts` / cdf$Population)*100000 

cdf$Year <- as.character(cdf$Year)

```

#### State

```{r}
NonState <- c("Northeast" , "Midwest" , "South" , "West", "Total U.S")


Drug_sdf <- left_join(Marj_df, Alco_df) %>%
  filter(!(Area %in% NonState ))

names(Drug_sdf)[names(Drug_sdf) == 'Area'] <- 'State'
Drug_sdf$Year <- as.numeric(Drug_sdf$Year)

dirt_sdf <- left_join(sui_sdf2, Drug_sdf)

sdf <- select(dirt_sdf, 'State', everything(),
             -c(Notes, 'State Code', 'Year Code'))

# pop in 1,000 and want percent
sdf$`Marj Usage` <- (sdf$`Marijuana Counts` / sdf$Population)*100000 
sdf$`Alco Usage` <- (sdf$`Alcohol Counts` / sdf$Population)*100000 

sdf$Year <- as.character(sdf$Year)
sdf$Deaths <- as.numeric(sdf$Deaths)

safe <- sdf

```

##### Cleaning

```{r}
sdf <- safe

# Suppressed Death 
fun1 <- function(x) if (is.na(x) == TRUE) {"Suppressed"} else {NA}
sdf$`Death Supress` <- mapply(fun1, sdf$Deaths)

# Adjust Death
fun2 <- function(x, y) if (is.na(x) == TRUE) {5} else {x}
sdf$Deaths <- mapply(fun2, sdf$Deaths)

# Status of Crude Rate
fun3 <- function(x) if (grepl("Suppressed", x) == TRUE | grepl("Unreliable", x) == TRUE)   {x} else {NA}
sdf$`Rate Status` <- mapply(fun3, sdf$`Crude Rate`)

# Crude Rate Calc
sdf$`Crude Rate Calc` <- (sdf$Deaths / sdf$Population)* 100000


str(sdf)
```












